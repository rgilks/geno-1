<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Generative 3D Music Visualizer (Web)</title>
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        background: #020308;
      }
      #app-canvas {
        width: 100vw;
        height: 100vh;
        display: block;
        touch-action: none;
      }
      .hint {
        position: fixed;
        left: 12px;
        bottom: 12px;
        color: #9bb;
        font: 12px/1.3 monospace;
        opacity: 0.8;
      }
      #start-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(2, 3, 8, 0.66);
        backdrop-filter: blur(2px);
        z-index: 10;
      }
      #start-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        text-align: center;
        color: #cfe7ff;
      }
      #start-keys {
        color: #9bb;
        font: 12px/1.4 monospace;
        max-width: 560px;
        background: rgba(20, 20, 30, 0.55);
        padding: 10px 12px;
        border: 1px solid rgba(80, 110, 150, 0.35);
        border-radius: 8px;
      }
      #start-btn {
        appearance: none;
        border: 1px solid #3a4b66;
        background: linear-gradient(#0b1220, #0a0f1a);
        color: #cfe7ff;
        font:
          600 14px system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          Cantarell,
          Noto Sans,
          Arial,
          sans-serif;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
      }
      #start-btn:hover {
        filter: brightness(1.1);
      }
      #start-btn:active {
        transform: translateY(1px);
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "env": "./pkg/env.js"
        }
      }
    </script>
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E"
    />
  </head>
  <body>
    <div id="start-overlay">
      <div id="start-content">
        <button id="start-btn">Start</button>
        <div id="start-keys">
          Click Start to begin<br />
          Click canvas: play a note • Mouse position affects sound<br />
          Keys: A..F (root) • 1..7 (mode) • R (new seq) • T (random key+mode) •
          Space (pause) • ArrowLeft/Right (tempo) • ArrowUp/Down (volume) •
          Enter (fullscreen) • Esc (exit)
        </div>
      </div>
    </div>
    <canvas id="app-canvas" width="1280" height="720"></canvas>
    <div class="hint" data-visible="0" style="display: none">
      Click Start to begin<br />
      Click canvas: play a note • Mouse position affects sound<br />
      A..F: root • 1..7: mode • R: new seq • T: random key+mode • Space:
      pause/resume • ArrowLeft/Right: tempo • Enter: fullscreen<br />
      BPM: 110 • Paused: no
    </div>
    <div
      id="audio-error"
      style="
        display: none;
        color: #caa;
        font: 14px/1.4 system-ui;
        position: fixed;
        left: 12px;
        top: 88px;
        max-width: 560px;
        background: rgba(20, 20, 30, 0.7);
        padding: 10px 12px;
        border-radius: 6px;
      "
    >
      Audio initialization failed (AudioContext). If audio permissions were
      denied or you are in a headless environment, audio will not play.
    </div>
    <div
      id="no-webgpu"
      style="
        display: none;
        color: #caa;
        font: 14px/1.4 system-ui;
        position: fixed;
        left: 12px;
        top: 12px;
        max-width: 560px;
        background: rgba(20, 20, 30, 0.7);
        padding: 10px 12px;
        border-radius: 6px;
      "
    >
      This demo requires WebGPU. Your browser either does not support it or it
      is disabled.<br />
      Try Chrome 113+ or Edge 113+ with WebGPU enabled.
    </div>
    <script type="module">
      const v = Date.now();
      console.log("[index] dynamic import cache-bust tag:", v);
      if (!("gpu" in navigator)) {
        const el = document.getElementById("no-webgpu");
        if (el) el.style.display = "block";
      }
      import(`./pkg/app_web.js?v=${v}`).then((m) => {
        console.log(
          "[index] wasm entry loaded url:",
          new URL(`./pkg/app_web.js?v=${v}`, window.location.href).toString()
        );
        return m.default();
      });
    </script>
  </body>
</html>
